name: Convert DynamicWorld Models

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-dynamicworld:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python 3.10
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. Upgrade pip
      - name: Upgrade pip
        run: pip install --upgrade pip

      # 4. Install required Python packages with compatible numpy
      - name: Install required Python packages
        run: |
          pip install "numpy<1.24"
          pip install tensorflow==2.13.1 tensorflowjs==3.18.0 tensorflow-hub==0.12.0 protobuf==3.20.3

      # 5. Check if dynamicworld/model exists
      - name: Check DynamicWorld model folder
        run: |
          if [ ! -d "./dynamicworld/model" ]; then
            echo "ERROR: ./dynamicworld/model folder not found!"
            exit 1
          fi

      # 6. Convert forward model with skip op check
      - name: Convert forward model to TFJS
        run: |
          echo "Converting forward model..."
          tensorflowjs_converter \
            --input_format=tf_saved_model \
            --output_format=tfjs_graph_model \
            --skip_op_check \
            ./dynamicworld/model/forward \
            ./dynamicworld/model/forward/tfjs_model

      # 7. Convert backward model with skip op check
      - name: Convert backward model to TFJS
        run: |
          echo "Converting backward model..."
          tensorflowjs_converter \
            --input_format=tf_saved_model \
            --output_format=tfjs_graph_model \
            --skip_op_check \
            ./dynamicworld/model/backward \
            ./dynamicworld/model/backward/tfjs_model

      # 8. Success message
      - name: Conversion complete
        run: echo "DynamicWorld models converted to TFJS successfully!"
