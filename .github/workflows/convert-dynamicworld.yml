name: Convert DynamicWorld to TFJS

on:
  workflow_dispatch:
    inputs:
      forward_savedmodel_path:
        description: "Path to forward SavedModel"
        required: true
        default: "model/forward"
      backward_savedmodel_path:
        description: "Path to backward SavedModel"
        required: false
        default: "model/backward"
      forward_output_path:
        description: "Output directory for forward TFJS model"
        required: false
        default: "server/models/dynamicworld/forward"
      backward_output_path:
        description: "Output directory for backward TFJS model"
        required: false
        default: "server/models/dynamicworld/backward"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone DynamicWorld repo
        run: git clone --depth 1 https://github.com/google/dynamicworld.git dynamicworld

      - name: Convert forward SavedModel -> TFJS (Docker)
        run: |
          echo "Converting forward model..."
          docker run --rm -v $PWD:/workspace tensorflow/tensorflow:2.12.0 \
          /bin/bash -c "
            pip install --upgrade pip &&
            pip install tensorflowjs==3.18.0 numpy<1.25 &&
            tensorflowjs_converter \
              --input_format=tf_saved_model \
              --signature_name=serving_default \
              --saved_model_tags=serve \
              /workspace/dynamicworld/${{ github.event.inputs.forward_savedmodel_path }} \
              /workspace/${{ github.event.inputs.forward_output_path }}
          "

      - name: Convert backward SavedModel -> TFJS (Docker)
        run: |
          if [ -d "dynamicworld/${{ github.event.inputs.backward_savedmodel_path }}" ]; then
            echo "Converting backward model..."
            docker run --rm -v $PWD:/workspace tensorflow/tensorflow:2.12.0 \
            /bin/bash -c "
              pip install --upgrade pip &&
              pip install tensorflowjs==3.18.0 numpy<1.25 &&
              tensorflowjs_converter \
                --input_format=tf_saved_model \
                --signature_name=serving_default \
                --saved_model_tags=serve \
                /workspace/dynamicworld/${{ github.event.inputs.backward_savedmodel_path }} \
                /workspace/${{ github.event.inputs.backward_output_path }}
            "
          else
            echo "Backward model path not present, skipping conversion."
          fi

      - name: Upload TFJS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dynamicworld-tfjs
          path: |
            ${{ github.event.inputs.forward_output_path }}/**
            ${{ github.event.inputs.backward_output_path }}/**
