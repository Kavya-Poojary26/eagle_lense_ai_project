name: EagleLensAI CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python 3.10
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      # 3️⃣ Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tensorflow tensorflowjs

      # 4️⃣ Verify DynamicWorld model exists
      - name: Check DynamicWorld model
        run: |
          if [ ! -d "./dynamicworld/model" ]; then
            echo "ERROR: DynamicWorld model folder not found!"
            exit 1
          else
            echo "DynamicWorld model found ✅"
          fi

      # 5️⃣ Convert DynamicWorld model to TensorFlow.js (if needed)
      - name: Convert DynamicWorld to TFJS
        run: |
          if [ -f "./dynamicworld/model/forward/saved_model.pb" ]; then
            tensorflowjs_converter \
              --input_format=tf_saved_model \
              --output_format=tfjs_graph_model \
              ./dynamicworld/model/forward \
              ./dynamicworld/tfjs_model/forward
          fi
          if [ -f "./dynamicworld/model/backward/saved_model.pb" ]; then
            tensorflowjs_converter \
              --input_format=tf_saved_model \
              --output_format=tfjs_graph_model \
              ./dynamicworld/model/backward \
              ./dynamicworld/tfjs_model/backward
          fi

      # 6️⃣ Optional: Run your tests or server
      - name: Run server check
        run: |
          echo "All setup complete. You can start your server here if needed."
