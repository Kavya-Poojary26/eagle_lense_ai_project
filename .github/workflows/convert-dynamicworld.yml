name: Convert DynamicWorld Model

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  convert-model:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Ensure model folder exists locally
      - name: Check DynamicWorld model folder
        run: |
          if [ ! -d "./models/dynamicworld" ]; then
            echo "ERROR: ./models/dynamicworld folder not found!"
            echo "Please download the DynamicWorld SavedModel manually and place it in ./models/dynamicworld"
            exit 1
          fi

      # 3. Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      # 4. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tensorflow tensorflowjs==3.18.0 tensorflow-hub protobuf==3.20.3

      # 5. Convert model to TensorFlow.js format
      - name: Convert DynamicWorld SavedModel to TFJS
        run: |
          echo "Converting DynamicWorld model..."
          tensorflowjs_converter \
            --input_format=tf_saved_model \
            --output_format=tfjs_graph_model \
            --signature_name=serving_default \
            ./models/dynamicworld \
            ./models/dynamicworld-tfjs
