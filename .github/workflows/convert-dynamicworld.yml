name: Convert DynamicWorld

on:
  workflow_dispatch:
    inputs:
      forward_savedmodel_path:
        description: "Relative path to forward SavedModel"
        required: true
        default: "model/forward"
      backward_savedmodel_path:
        description: "Relative path to backward SavedModel"
        required: false
        default: "model/backward"
      commit_changes:
        description: "Commit converted TFJS back to repo?"
        required: true
        default: "false"
      forward_output_path:
        description: "Custom output directory for forward TFJS model"
        required: false
        default: "server/models/dynamicworld/forward"
      backward_output_path:
        description: "Custom output directory for backward TFJS model"
        required: false
        default: "server/models/dynamicworld/backward"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "numpy<2"
          pip install tensorflow-cpu==2.12.0
          pip install tensorflowjs==4.8.0  # fixed version without JAX

      - name: Clone DynamicWorld
        run: git clone --depth 1 https://github.com/google/dynamicworld.git dynamicworld

      - name: Convert forward SavedModel -> TFJS
        env:
          SAVEDMODEL_PATH: ${{ github.event.inputs.forward_savedmodel_path }}
          OUTPUT_PATH: ${{ github.event.inputs.forward_output_path }}
        run: |
          tensorflowjs_converter \
            --input_format=tf_saved_model \
            --signature_name=serving_default \
            --saved_model_tags=serve \
            dynamicworld/${SAVEDMODEL_PATH} \
            ${OUTPUT_PATH} || (echo "forward conversion failed" && exit 1)

      - name: Convert backward SavedModel -> TFJS
        env:
          SAVEDMODEL_PATH: ${{ github.event.inputs.backward_savedmodel_path }}
          OUTPUT_PATH: ${{ github.event.inputs.backward_output_path }}
        run: |
          if [ -d "dynamicworld/${SAVEDMODEL_PATH}" ]; then
            tensorflowjs_converter \
              --input_format=tf_saved_model \
              --signature_name=serving_default \
              --saved_model_tags=serve \
              dynamicworld/${SAVEDMODEL_PATH} \
              ${OUTPUT_PATH} || echo "backward conversion failed"
          else
            echo "Backward model path not present, skipping"
          fi

      - name: Show converted model sizes
        run: |
          du -sh ${{ github.event.inputs.forward_output_path }} || true
          du -sh ${{ github.event.inputs.backward_output_path }} || true

      - name: Commit TFJS models (optional)
        if: ${{ github.event.inputs.commit_changes == 'true' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ${{ github.event.inputs.forward_output_path }} ${{ github.event.inputs.backward_output_path }} || true
          git commit -m "Add converted DynamicWorld TFJS models [ci]" || echo "nothing to commit"
          git push origin HEAD:${{ github.ref_name || github.head_ref || github.ref }} || echo "push failed"

      - name: Upload TFJS artifacts (if not committing)
        if: ${{ github.event.inputs.commit_changes != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dynamicworld-tfjs
          path: |
            ${{ github.event.inputs.forward_output_path }}/**
            ${{ github.event.inputs.backward_output_path }}/**

      - name: Done
        run: echo "DynamicWorld TFJS conversion workflow finished."
