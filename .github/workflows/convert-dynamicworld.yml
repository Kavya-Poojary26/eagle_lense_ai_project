name: Convert DynamicWorld Model

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-dynamicworld:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tensorflow==2.13.1 tensorflowjs==3.18.0 tensorflow-hub==0.12.0 protobuf==3.20.3

    - name: Download DynamicWorld SavedModel
      run: |
        mkdir -p ./models
        cd ./models
        # Download the official DynamicWorld model from Google Cloud Storage
        curl -L -o dynamicworld.zip "https://storage.googleapis.com/dynamicworld-public/models/dynamicworld_v1_20220411.zip"
        unzip dynamicworld.zip -d dynamicworld
        rm dynamicworld.zip
        cd ../

    - name: Convert to TensorFlow.js format
      run: |
        mkdir -p ./tfjs_models
        tensorflowjs_converter \
          --input_format=tf_saved_model \
          --output_format=tfjs_graph_model \
          --skip_op_check \
          ./models/dynamicworld \
          ./tfjs_models/dynamicworld

    - name: Done
      run: echo "DynamicWorld model downloaded and converted successfully!"
